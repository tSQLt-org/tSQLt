{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "newVMName": {
      "type": "string",
      "defaultValue": "SQL2008SP3B"	
    },
    "labName": {
      "type": "string",
      "defaultValue": "tsqltci_devtestlab_3"
    },
    "DevTestLabVirtualNetworkName": {
      "type": "string",
      "defaultValue": ""
    },
    "DevTestLabVirtualNetworkSubNetName": {
      "type": "string",
      "defaultValue": ""
    },
    "size": {
      "type": "string",
      "defaultValue": "Standard_B2s"
    },
    "template": {
      "type": "string",
      "defaultValue": "sql2014sp3-ws2012r2"
    },
    "templateDescription": {
      "type": "string",
      "defaultValue": "Free SQL Server License: SQL Server 2014 SP3 Developer on Windows Server 2012 R2 "
    },
    "templatePublisher": {
      "type": "string",
      "defaultValue": "microsoftsqlserver"
    },
    "templateSKU": {
      "type": "string",
      "defaultValue": "sqldev"
    },
    "userName": {
      "type": "string",
      "defaultValue": "tSQLt"
    },
    "password": {
      "type": "string",
      "defaultValue": "yeyeyeyeyeiueriuweryiwuerywieury77RR(u)"
    },
    "domain": {
      "type": "string",
      "defaultValue": "sebastiansqlity.onmicrosoft.com"
    },
    "ContactEmail": {
      "type": "string",
      "defaultValue": ""
    },
	"sqlConnectivityType": {
		"type": "string",
      "defaultValue": "Public"
	},
	"sqlPortNumber": {
		"type": "int",
      "defaultValue": 41433
	},
	"sqlStorageDisksCount": {
		"type": "int",
      "defaultValue": 1
	},
	"sqlStorageWorkloadType": {
		"type": "string",
      "defaultValue": "DW"
	},
	"sqlStorageDisksConfigurationType": {
		"type": "string",
      "defaultValue": "NEW"
	},
	"sqlStorageStartingDeviceId": {
		"type": "int",
      "defaultValue": 2
	},
	"sqlStorageDeploymentToken": {
		"type": "int",
      "defaultValue": 50726
	},
	"sqlAutopatchingDayOfWeek": {
		"type": "string",
      "defaultValue": "Sunday"
	},
	"sqlAutopatchingStartHour": {
		"type": "string",
      "defaultValue": "2"
	},
	"sqlAutopatchingWindowDuration": {
		"type": "string",
      "defaultValue": "60"
	},
	"sqlAuthenticationLogin": {
		"type": "string",
      "defaultValue": "tSQLt"
	},
	"sqlAuthenticationPassword": {
		"type": "securestring",
      "defaultValue": "sdlfksdlkfjlsdkjf39939^"
	},
	"dataPath": {
		"type": "string",
      "defaultValue": "C:\\sql\\data"
	},
	"dataDisksLUNs": {
		"type": "array",
      "defaultValue": [0]
	},
	"logPath": {
		"type": "string",
      "defaultValue": "C:\\sql\\log"
	},
	"logDisksLUNs": {
		"type": "array",
      "defaultValue": [0]
	},
	"tempDbPath": {
		"type": "string",
      "defaultValue": "C:\\sql\\tempDb"
	},
	"tempDisksLUNs": {
		"type": "array",
      "defaultValue": [0]
	},
	"rServicesEnabled": {
		"type": "string",
      "defaultValue": "false"
	}	
  },
  "variables": {
    "vmId": "[resourceId ('Microsoft.DevTestLab/labs/virtualmachines', parameters('labName'), parameters('newVMName'))]",
    "vmName": "[concat(parameters('labName'), '/', parameters('newVMName'))]",
	"labNicName": "[concat(parameters('newVMName'), '-NetworkInterface-1')]",
	"labSubnetPrefix": "10.0.0.0/24",
	"labPublicIPAddressName": "[concat(parameters('newVMName'), 'publicIPAddress-1')]"
  },
  "resources": [
    {
      "apiVersion": "2018-09-15",
      "type": "Microsoft.DevTestLab/labs/virtualmachines",
      "name": "[variables('vmName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "notes": "[parameters('templateDescription')]",
		"labVirtualNetworkId":"[resourceId('Microsoft.DevTestLab/labs/virtualnetworks', parameters('labName'), parameters('DevTestLabVirtualNetworkName'))]",
		"labSubnetName":"[parameters('DevTestLabVirtualNetworkSubNetName')]",
        "galleryImageReference": {
          "offer": "[parameters('template')]",
          "publisher": "[parameters('templatePublisher')]",
          "sku": "[parameters('templateSKU')]",
          "osType": "Windows",
          "version": "latest"
        },
        "size": "[parameters('size')]",
        "userName": "[parameters('userName')]",
        "password": "[parameters('password')]",
        "isAuthenticationWithSshKey": false,
        "artifacts": [
          {
            "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-winrm')]",
            "parameters": [
              {
                "name": "hostName",
                "value": "[concat(parameters('newVMName'),'.', parameters('domain'))]"
              }
            ]
          }
        ],
        "disallowPublicIpAddress": false,
        "storageType": "Standard",
        "allowClaim": true,
		"networkInterface": {
		}		
      }
    },
	{
		"type": "microsoft.devtestlab/labs/virtualmachines/schedules",
		"apiVersion": "2018-09-15",
		"name": "[concat(parameters('labName'), '/', parameters('newVMName'),'/labvmsshutdown')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
		"[resourceId('Microsoft.DevTestLab/labs/virtualmachines', parameters('labName'), parameters('newVMName'))]"
		],
		"properties": {
			"status": "Enabled",
			"taskType": "LabVmsShutdownTask",
			"dailyRecurrence": {
				"time": "0700"
			},
			"timeZoneId": "GMT Standard Time",
			"notificationSettings": {
				"status": "Enabled",
				"timeInMinutes": 30,
				"emailRecipient": "parameters('ContactEmail')",
				"notificationLocale": "en"
			},
			"targetResourceId": "[resourceId('Microsoft.DevTestLab/labs/virtualmachines', parameters('labName'), parameters('newVMName'))]"
		}
	},

	{
		"name": "[parameters('newVMName')]",
		"type": "Microsoft.SqlVirtualMachine/SqlVirtualMachines",
		"apiVersion": "2017-03-01-preview",
		"location": "[parameters('sqlVirtualMachineLocation')]",
		"properties": {
			"virtualMachineResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('newVMName'))]",
			"sqlManagement": "Full",
			"SqlServerLicenseType": "PAYG",
			"AutoPatchingSettings": {
				"Enable": true,
				"DayOfWeek": "[parameters('sqlAutopatchingDayOfWeek')]",
				"MaintenanceWindowStartingHour": "[parameters('sqlAutopatchingStartHour')]",
				"MaintenanceWindowDuration": "[parameters('sqlAutopatchingWindowDuration')]"
			},
			"KeyVaultCredentialSettings": {
				"Enable": false,
				"CredentialName": ""
			},
			"StorageConfigurationSettings": {
				"DiskConfigurationType": "[parameters('sqlStorageDisksConfigurationType')]",
				"StorageWorkloadType": "[parameters('sqlStorageWorkloadType')]",
				"SQLDataSettings": {
					"DefaultFilePath": "[parameters('dataPath')]"
				},
				"SQLLogSettings": {
					"DefaultFilePath": "[parameters('logPath')]"
				},
				"SQLTempDbSettings": {
					"DefaultFilePath": "[parameters('tempDbPath')]",
				}
			},
			"ServerConfigurationsManagementSettings": {
				"SQLConnectivityUpdateSettings": {
					"ConnectivityType": "[parameters('sqlConnectivityType')]",
					"Port": "[parameters('sqlPortNumber')]",
					"SQLAuthUpdateUserName": "[parameters('sqlAuthenticationLogin')]",
					"SQLAuthUpdatePassword": "[parameters('sqlAuthenticationPassword')]"
				},
				"AdditionalFeaturesServerConfigurations": {
					"IsRServicesEnabled": "[parameters('rServicesEnabled')]"
				}
			}
		},
		"dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines', parameters('sqlVirtualMachineName'))]"
		]
	}
	
  ],
  "outputs": {
    "labVMId": {
      "type": "string",
      "value": "[variables('vmId')]"
    }
  }
}